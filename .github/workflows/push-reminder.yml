name: Push Notification Reminder

on:
  schedule:
    # 매시간 실행 (UTC 기준)
    # 한국 시간으로 매시간 알림을 받으려면 UTC 시간으로 설정
    - cron: '0 * * * *'

  # 수동 실행 가능
  workflow_dispatch:

jobs:
  send-reminder:
    runs-on: ubuntu-latest

    steps:
      - name: Send Push Notification
        run: |
          # Railway 배포 URL로 푸시 알림 트리거
          # Railway에 배포 후 실제 URL로 변경 필요
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            ${{ secrets.RAILWAY_APP_URL }}/api/push/send-scheduled-reminder)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Failed to send push notification"
            exit 1
          fi

      - name: Health Check
        if: always()
        run: |
          # 앱 상태 확인
          curl -f ${{ secrets.RAILWAY_APP_URL }}/api/today || echo "Health check failed"
